sources:
  alloydb-api-source:
    kind: http
    baseUrl: https://alloydb.googleapis.com
    headers:
      Authorization: Bearer ${API_KEY}
      Content-Type: application/json
tools:
  alloydb-create-cluster:
    kind: http
    source: alloydb-api-source
    method: POST
    path: /v1/projects/{{.projectId}}/locations/{{.locationId}}/clusters
    description: "Create a new AlloyDB cluster. This is a long-running operation, but the API call returns quickly. This will return operation id to be used by get operations tool. Take all parameters from user in one go."
    pathParams:
      - name: projectId
        type: string
        description: "The dynamic path parameter for project id provided by user."
      - name: locationId
        type: string
        description: "The dynamic path parameter for location. The default value is us-central1. If quota is exhausted then use other regions."
        default: us-central1
    queryParams:
      - name: clusterId
        type: string
        description: "A unique ID for the AlloyDB cluster."
    requestBody: |
      {
        "networkConfig": {
          "network": "projects/{{.project}}/global/networks/{{.network}}"
        },
        "initialUser": {
          "password": "{{.password}}",
          "user": "{{.user}}"
        }
      }
    bodyParams:
      - name: project
        type: string
        description: "The dynamic path parameter for project id."
      - name: network
        type: string
        description: "The name of the VPC network to connect the cluster to (e.g., 'default')."
        default: default
      - name: password
        type: string
        description: "A secure password for the initial 'postgres' user or the custom user provided."
      - name: user
        type: string
        description: "The name for the initial superuser. If not provided, it defaults to 'postgres'. The initial database will always be named 'postgres'."
  alloydb-operations-get:
    kind: alloydb-wait-for-operation
    description: "This will poll on operations API until the operation is done. For checking operation status we need projectId, locationID and operationId. Once instance is created give follow up steps on how to use the variables to bring data plane MCP server up in local and remote setup."
    delay: 1s
    maxDelay: 4m
    multiplier: 2
    maxRetries: 10
  alloydb-create-instance:
    kind: http
    source: alloydb-api-source
    method: POST
    path: /v1/projects/{{.projectId}}/locations/{{.locationId}}/clusters/{{.clusterId}}/instances
    description: "Creates a new AlloyDB instance (PRIMARY, READ_POOL, or SECONDARY) within a cluster. This is a long-running operation. Take all parameters from user in one go. This will return operation id to be used by get operations tool."
    pathParams:
      - name: projectId
        type: string
        description: "The GCP project ID."
      - name: locationId
        type: string
        description: "The location of the cluster (e.g., 'us-central1')."
        default: us-central1
      - name: clusterId
        type: string
        description: "The ID of the cluster to create the instance in."
    queryParams:
      - name: instanceId
        type: string
        description: "A unique ID for the new AlloyDB instance."
    requestBody: |
      {
        "instanceType": "{{.instanceType}}",
        {{- if .displayName }}
        "displayName": "{{.displayName}}",
        {{- end }}
        {{- if eq .instanceType "READ_POOL" }}
        "readPoolConfig": {
          "nodeCount": {{.nodeCount}}
        },
        {{- end }}
        {{- if eq .instanceType "SECONDARY" }}
        "secondaryConfig": {
          "primaryClusterName": "{{.primaryClusterName}}"
        },
        {{- end }}
        "networkConfig": {
          "enablePublicIp": true
        },
        "databaseFlags": {
          "password.enforce_complexity": "on"
        }
      }
    bodyParams:
      - name: instanceType
        type: string
        description: "The type of instance to create. Required. Valid values are: PRIMARY, READ_POOL, SECONDARY."
      - name: displayName
        type: string
        description: "An optional, user-friendly name for the instance."
      - name: nodeCount
        type: integer
        description: "The number of nodes in the read pool. Required only if instanceType is READ_POOL. Default is 1."
        default: 1
      - name: primaryClusterName
        type: string
        description: "The full resource name of the primary cluster for a SECONDARY instance. Required only if instanceType is SECONDARY. Otherwise don't ask"
        default: ""
  alloydb-list-clusters:
      kind: http
      source: alloydb-api-source
      method: GET
      path: /v1/projects/{{.projectId}}/locations/{{.locationId}}/clusters
      description: "Lists all AlloyDB clusters in a given project and location."
      pathParams:
        - name: projectId
          type: string
          description: "The GCP project ID to list clusters for."
        - name: locationId
          type: string
          description: "The location to list clusters in (e.g., 'us-central1'). Use '-' to list clusters across all locations."
          default: "-"
  alloydb-list-instances:
    kind: http
    source: alloydb-api-source
    method: GET
    path: /v1/projects/{{.projectId}}/locations/{{.locationId}}/clusters/{{.clusterId}}/instances
    description: "Lists all AlloyDB instances within a specific cluster."
    pathParams:
      - name: projectId
        type: string
        description: "The GCP project ID."
      - name: locationId
        type: string
        description: "The location of the cluster (e.g., 'us-central1'). Use '-' to get results for all regions."
        default: "-"
      - name: clusterId
        type: string
        description: "The ID of the cluster to list instances from. Use '-' to get results for all clusters."
        default: "-"
  alloydb-list-users:
    kind: http
    source: alloydb-api-source
    method: GET
    path: /v1/projects/{{.projectId}}/locations/{{.locationId}}/clusters/{{.clusterId}}/users
    description: "Lists all database users within a specific AlloyDB cluster."
    pathParams:
      - name: projectId
        type: string
        description: "The GCP project ID."
      - name: locationId
        type: string
        description: "The location of the cluster (e.g., 'us-central1')."
        default: us-central1
      - name: clusterId
        type: string
        description: "The ID of the cluster to list users from."
  alloydb-create-user:
    kind: http
    source: alloydb-api-source
    method: POST
    path: /v1/projects/{{.projectId}}/locations/{{.locationId}}/clusters/{{.clusterId}}/users
    description: "Creates a new database user in an AlloyDB cluster. Takes the new user's name and a secure password. Optionally, a list of database roles can be assigned."
    pathParams:
      - name: projectId
        type: string
        description: "The GCP project ID."
      - name: locationId
        type: string
        description: "The location of the cluster (e.g., 'us-central1')."
        default: us-central1
      - name: clusterId
        type: string
        description: "The ID of the cluster where the user will be created."
    queryParams:
      - name: userId
        type: string
        description: "The name for the new user. Must be unique within the cluster."
    requestBody: |
      {
        "userType": "{{.userType}}"
        {{- if eq .userType "ALLOYDB_BUILT_IN" -}}
        , "password": "{{.password}}"
        {{- end -}}
        {{- if .databaseRoles }}
        , "databaseRoles": [{{range $i, $role := .databaseRoles}}{{if $i}},{{end}}"{{$role}}"{{end}}]
        {{- end }}
      }
    bodyParams:
      - name: password
        type: string
        description: "A secure password for the new user. Required only for ALLOYDB_BUILT_IN userType."
        required: false
      - name: databaseRoles
        type: array
        description: "Optional. A list of database roles to grant to the new user (e.g., ['pg_read_all_data']). If not specified, the user will have no roles."
        items:
          name: role
          type: string
          description: "A single database role to grant to the user (e.g., 'pg_read_all_data')."
      - name: userType
        type: string
        description: "The type of user to create. Valid values are: USER_TYPE_UNSPECIFIED, ALLOYDB_BUILT_IN, ALLOYDB_IAM_USER."
        default: "ALLOYDB_BUILT_IN"
        
toolsets:
  alloydb-postgres-admin-tools:
    - alloydb-create-cluster
    - alloydb-operations-get
    - alloydb-create-instance
    - alloydb-list-clusters
    - alloydb-list-instances
    - alloydb-list-users
    - alloydb-create-user